name: Release of CLI

on:
  push:
    branches: ["stable"]
    tags: ["[0-9]+.[0-9]+.*"]
    paths:
      - 'cli/**'

### ${{ secrets.GITHUB_TOKEN }} ###4
## TODO: Versioning

jobs:
  # TODO: Do a double-check on versioning
  build_linux:
    permissions:
      attestations: write
      id-token: write
    uses: ./.github/workflows/build-linux.yml
    secrets: inherit

  build_macos:
    permissions:
      attestations: write
      id-token: write
    uses: ./.github/workflows/build-macos.yml
    secrets: inherit

  build_windows:
    permissions:
      attestations: write
      id-token: write
    uses: ./.github/workflows/build-windows.yml
    secrets: inherit

  release-github:
    name: Release Github
    runs-on: ubuntu-latest
    needs: [build_linux, build_macos, build_windows]

    steps:
      - uses: actions/checkout@v4
      - name: Deploy
        run: dart run grinder pkg-github-release
        env:
          GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          GH_USER: pritt-bot

  deploy-github:
    runs-on: ubuntu-latest
    needs: [release-github]

    permissions:
      contents: write

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4

      - name: Release
        run: gh release upload ${{ github.ref_name }} build-*/* --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ github.token }}

  deploy_homebrew:
    name: Deploy Homebrew
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - run: dart pub get

      - name: Deploy
        run: dart run grinder pkg-homebrew-update
        env:
          GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          GH_USER: pritt-bot

  deploy_chocolatey:
    name: Deploy Chocolatey
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Deploy
        run: dart run grinder pkg-chocolatey-deploy
        env:
          CHOCOLATEY_TOKEN: "${{ secrets.CHOCOLATEY_TOKEN }}"
